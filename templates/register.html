<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>注册</title>
    <link rel="stylesheet" href="/static/bootstrap-3.3.7-dist/css/bootstrap.css">
    <script src="/static/js/jquery-3.4.1.js"></script>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <div class="col-md-6 col-md-offset-3">
            <form id="my_form">
            <h1>注册</h1>
            {% csrf_token %} <!--没必要在ajax中再添加csrf_token，因为ajax中的数据全都包到了form表单中进行提交，见data: formdata-->
            {% for foo in form %}
                <div class="form-group">
                    <!--foo.auto_id 就是foo生成的input框的id-->
                    <label for="{{ foo.auto_id }}">{{ foo.label }}</label>
                    {{ foo }}<span style="color: red" class=" error pull-right"></span>
                </div>
            {% endfor %}
                <div class="form-group">
                    <label for="id_file" >
                        头像
                        <img src="/static/img/default.png" width="80" height="80" style="margin-left: 20px" id="id_img">
                    </label>
                    <input type="file" name="file" id="id_file" style="display: none">
                </div>
                <!--由于用外层用了form，所以把这里的type="submit"换成type="button"，否则会提交两次-->
                <input type="button" class="btn btn-success" value="提交" id="id_submit">
            </form>
        </div>
    </div>
</div>
</body>

<script>
    $("#id_file").change(function(){
        //alert(1)
        //取到文件对象
        var file=$("#id_file")[0].files[0]
        //放到img控件上，借助filereader 中间的东西，叫做文件阅读器
        //生成一个文件阅读器对象赋值给filereader
        var filereader = new FileReader()
        //把文件读到filereader对象中
        //读文件需要时间，需要文件读完再去操作img
        filereader.readAsDataURL(file)
        //onload代表加载完成之后再去操作
        filereader.onload=function(){
            $('#id_img').attr('src',filereader.result)
        }
    })


    $("#id_submit").click(function() {
        //ajax 上传文件

        var formdata = new FormData()

        //一个一个往里加，稍微复杂，用简便方法
        //formdata.append('name',$("#id_name").val())
        //formdata.append('pwd',$("#id_pwd").val())

        //简便方法
        //form对象的serializeArray，它会把form中的数据包装到一个对象中，不包含文件
        var my_form_data = $("#my_form").serializeArray()
        //console.log(typeof my_form_data)
        //console.log(my_form_data)

        //jquery封装的each函数，相当于for循环，第一个参数是要循环的对象
        //第二个参数是一个匿名函数，函数中必须带两个参数
        $.each(my_form_data, function (key, value) {
            {#console.log(key)#}
            {#console.log(value)#}
            formdata.append(value.name, value.value)
        })
        formdata.append('avatar', $("#id_file")[0].files[0])


        $.ajax({
            url: '/register/',
            //如果为空，则url默认为当前页面
            //ajax这里必须要加斜杠，因为只有django框架会重定向，而ajax不会重定向。爬虫也不会重定向
            type: 'post',
            processData: false,//告诉jQuery不要去处理发送的数据
            contentType: false,//告诉jQuery不要去设置Content-Type请求头
            //默认为contentType:'application/x-www-form-urlencoded'
            data: formdata,//formdata这个对象封装了头和处理数据

            success: function (data) {
                //console.log(data)
                if(data.code==100){
                    location.href='/login/'
                }else if(data.code==101){
                    //如果错误code==101，则data.msg是个字典
                    //如果错误code==103，则data.mag是字符串
                    $.each(data.msg,function (key,value) {
                        console.log(key)
                        console.log(value)
                        //next表示下一个控件<span></span>,见单词foo附近
                        $("#id_"+key).next().html(value[0])
                        if(key=='__all__'){
                            $("#id_re_pwd").next().html(value[0])
                        }

                    })
                }
                //定时器
                setTimeout(function () {
                    $(".error").html("")
                },3000)
            }

        })
    })

</script>

</html>
